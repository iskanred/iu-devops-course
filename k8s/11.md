# Secrets & Resource Management

## Kubernetes Secrets

### Creation via `kubectl`
The file with the secret value is located in `k8s/secret.txt`:
```text
secret_value
```

* **Create a secret `secret-example`**
    
  <u>Command:</u>
  ```shell
  kubectl create secret generic secret-example \                             
  --from-file=secret=./secret.txt
  ```
  <u>Output:</u>
  ```text
  secret/secret-example created
  ```

* **Get secrets**

  <u>Command:</u>
  ```shell
  kubectl get secret
  ```
  <u>Output:</u>
  ```text
  NAME             TYPE     DATA   AGE
  secret-example   Opaque   1      4s
  ```

* **Describe secret `secret-example`**

  <u>Command:</u>
  ```shell
  kubectl describe secret secret-example
  ```
  <u>Output:</u>
  ```text
  Name:         secret-example
  Namespace:    default
  Labels:       <none>
  Annotations:  <none>

  Type:  Opaque

  Data
  ====
  secret:  12 bytes
  ```

* **Decode secret value**

  <u>Command:</u>
  ```shell
  kubectl get secret secret-example -o jsonpath='{.data.secret}' | base64 --decode
  ```
  <u>Output:</u>
  ```text
  secret_value
  ```

### Creation via Helm

The task is done with the help of [**helm secrets**](http://github.com/zendesk/helm-secrets) plugin.

**GPG** secret encryption backend is used. The generated public file is located in `k8s/secrets.yaml`.

The sensitive data:
```text
password: he:lm_secret_value
```

* After plugin installation and encrypting the sensitive data I have added file `k8s/app-python/templates/secrets.yaml` which describes the K8S secret object:
  ```yaml
  apiVersion: v1

  kind: Secret
  metadata:
    name: helm-secret-example
    labels:
      {{- include "app-python.labels" . | nindent 4 }}

  type: Opaque
  data:
    password: {{ .Values.password | b64enc | quote }}
  ```
* Then, I have added environment variable section to `k8s/app-python/templates/deployment.yaml`:
  ```yaml
  ...
  env:
    - name: HELM_SECRET_EXAMPLE_PASSWORD
      valueFrom:
        secretKeyRef:
          name: helm-secret-example
          key: password
  ...
  ``` 
* Finally, I can install release:

  <u>Command:</u>
  ```shell
  helm secrets install app-python-release ./app-python -f ./secrets.yaml
  ```
  <u>Output:</u>
  ```text
  NAME: app-python-release
  LAST DEPLOYED: Mon Nov 13 21:14:46 2023
  NAMESPACE: default
  STATUS: deployed
  REVISION: 1
  NOTES:
  1. Get the application URL by running these commands:
     export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=app-python,app.kubernetes.io/instance=app-python-release" -o jsonpath="{.items[0].metadata.name}")
     export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
     echo "Visit http://127.0.0.1:8080 to use your application"
     kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
     ./secrets.yaml.dec
    ```
* After all, let's get pods:

  <u>Command:</u>
  ```shell
  kubectl get po
  ```
  <u>Output:</u>
  ```text
  NAME                                  READY   STATUS    RESTARTS   AGE
  app-python-release-8454f4589f-d22xh   1/1     Running   0          10m
  app-python-release-8454f4589f-mrjtk   1/1     Running   0          10m
  ```
  
* The last step is to check environment variable value inside the pod:

  <u>Command:</u>
  ```shell
  kubectl exec app-python-release-8454f4589f-d22xh -- printenv | grep HELM_SECRET_EXAMPLE_PASSWORD
  ```
  <u>Output:</u>
  ```text
  HELM_SECRET_EXAMPLE_PASSWORD=he:lm_secret_value
  ```
  
## Vault Secret Management System

The task is done with the help of [**vault-helm**](https://github.com/hashicorp/vault-helm) chart.

The sensitive data:
```text
password: vault_secret_value
```

The application chart is located in `k8s/app-kotlin`.

### Actions
1. First, I have installed **vault** helm chart.
2. Then, I have configured its agent and backend using the [tutorial](https://developer.hashicorp.com/vault/tutorials/kubernetes/kubernetes-sidecar#inject-secrets-into-the-pod). I have put secret (on path `internal/data/secrets`) and configured k8s auth.
3. After all, I have added changes to the application chart `values.yaml` file:
    ```yaml
    serviceAccount:
      create: false
      name: "internal-app"

    podAnnotations:
      vault.hashicorp.com/agent-inject: "true"
      vault.hashicorp.com/role: "internal-app"
      vault.hashicorp.com/agent-inject-secret-secrets.txt: "internal/data/secrets"
    ```
4. Finally, I have install the application chart:

    <u>Command:</u>
    ```shell
    helm install app-kotlin-release app-kotlin
    ```
   <u>Output:</u>
    ```text
    NAME: app-kotlin-release
    LAST DEPLOYED: Tue Nov 14 03:16:49 2023
    NAMESPACE: default
    STATUS: deployed
    REVISION: 1
    NOTES:
    1. Get the application URL by running these commands:
       export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=app-kotlin,app.kubernetes.io/instance=app-kotlin-release" -o jsonpath="{.items[0].metadata.name}")
       export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
       echo "Visit http://127.0.0.1:8080 to use your application"
       kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT
    ```

### Results
* **Get pods**

  <u>Command:</u>
    ```shell
    kubectl get po
    ```
  <u>Output:</u>
    ```text
    NAME                                    READY   STATUS    RESTARTS   AGE
  app-kotlin-release-7bc86b875c-kcqjw     2/2     Running   0          13m
  app-kotlin-release-7bc86b875c-r9j4b     2/2     Running   0          13m
  vault-0                                 1/1     Running   0          18m
  vault-agent-injector-5cd8b87c6c-6jvhz   1/1     Running   0          18m
    ```

* **Connect to application container**

  <u>Command:</u>
    ```shell
    kubectl exec -it app-kotlin-release-7bc86b875c-kcqjw -c app-kotlin -- bash
    ```
* **Get secrets inside the container**

  <u>Command:</u>
  ```shell
  cat /vault/secrets/secrets.txt
  ```
  <u>Output:</u>
  ```text
  data: map[password:vault_secret_value]
  metadata: map[created_time:2023-11-14T00:12:56.797338Z custom_metadata:<nil> deletion_time: destroyed:false version:1]
  ```
* **Get filesystems info**

  <u>Command:</u>
  ```shell
  df -h
  ```
  <u>Output:</u>
  ```text
  Filesystem                      Size  Used Avail Use% Mounted on
  overlay                          69G   16G   50G  25% /
  tmpfs                            64M     0   64M   0% /dev
  tmpfs                           5.9G     0  5.9G   0% /sys/fs/cgroup
  tmpfs                           628M  4.0K  628M   1% /vault/secrets
  /dev/disk/by-label/data-volume   69G   16G   50G  25% /etc/hosts
  shm                              64M     0   64M   0% /dev/shm
  tmpfs                           628M   12K  628M   1% /run/secrets/kubernetes.io/serviceaccount
  tmpfs                           5.9G     0  5.9G   0% /proc/acpi
  tmpfs                           5.9G     0  5.9G   0% /proc/scsi
  tmpfs                           5.9G     0  5.9G   0% /sys/firmware
  ```
* Changing secret template:
  ```yaml
  ...
  podAnnotations:
    vault.hashicorp.com/agent-inject-secret-secrets.txt: |
      {{- with secret "internal/data/secrets" -}}
      {{ .Data.data.password }}
      {{- end -}}
  ...
  ```
* **Get secrets inside the container**

  <u>Command:</u>
    ```shell
    cat /vault/secrets/secrets.txt
    ```
  <u>Output:</u>
    ```text
    vault_secret_value
    ```

## Resource Management

I have already set limits during the previous lab.

* `app-python`
  ```yaml
  resources:
   limits:
     cpu: 100m
     memory: 128Mi
   requests:
     cpu: 100m
     memory: 128Mi
  ```
* `app-kotlin`
  ```yaml
  resources:
   limits:
     cpu: 350m
     memory: 500Mi
   requests:
     cpu: 350m
     memory: 500Mi
  ```

## Environment variables
The application chart is `k8s/app-python`.

1. I have added the following env in `k8s/app-python/templates/_heplers.tpl`:
    ```gotemplate
    {{/*
    Environment variables
    */}}
    {{- define "app-python.env" -}}
    - name: MY_ENV
      value: "value"
    {{- end }}
    ```
2. Then, I have added the template data to `deployment.yaml` to `spec.template.spec.containers.env`:
    ```yaml
    {{- include "app-python.env" . | nindent 12 }}
    ```
3. Finally, we can check the results:
    * **Get pods**

      <u>Command:</u>
        ```shell
        kubectl get po
        ```
      <u>Output:</u>
        ```text
        NAME                                  READY   STATUS        RESTARTS   AGE
        app-python-release-57449bc6cc-2ncgv   1/1     Running       0          8m9s
        app-python-release-57449bc6cc-6rw27   1/1     Running       0          8m9s
        ```
    * **Check env**

      <u>Command:</u>
        ```shell
        kubectl exec app-python-release-57449bc6cc-2ncgv -- printenv | grep MY_ENV
        ```
      <u>Output:</u>
        ```text
        MY_ENV=value
        ```

